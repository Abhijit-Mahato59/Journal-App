<h3>Calendar</h3>

@page "/calendar"
@inject JournalApp.Services.IJournalService JournalService
@inject NavigationManager Nav

<h1 class="screen-title">Calendar</h1>

<div class="month-header">
    <button class="btn" @onclick="PrevMonth">&lt;</button>
    <div class="month-title">@current.ToString("MMMM yyyy")</div>
    <button class="btn" @onclick="NextMonth">&gt;</button>
</div>

<div class="dow">
    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thurs</div><div>Fri</div><div>Sat</div>
</div>

<div class="cal-grid">
    @foreach (var cell in cells)
    {
        if (cell is null)
        {
            <div class="cal-cell empty"></div>
        }
        else
        {
            var d = cell.Value;
            var hasEntry = entryDates.Contains(d.Date);

            <button class="cal-cell day @(hasEntry ? "has-entry" : "")"
                    @onclick="() => OpenDate(d)">
                @d.Day
            </button>
        }
    }
</div>

@code {
    private DateTime current = new(DateTime.Today.Year, DateTime.Today.Month, 1);
    private List<DateTime?> cells = new();
    private HashSet<DateTime> entryDates = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadMonth();
    }

    private async Task LoadMonth()
    {
        entryDates = await JournalService.GetEntryDatesInMonthAsync(current.Year, current.Month);

        cells.Clear();
        var first = new DateTime(current.Year, current.Month, 1);
        var daysInMonth = DateTime.DaysInMonth(current.Year, current.Month);

        // Sunday=0 .. Saturday=6
        var startOffset = (int)first.DayOfWeek;

        // fill blanks
        for (int i = 0; i < startOffset; i++)
            cells.Add(null);

        // fill days
        for (int day = 1; day <= daysInMonth; day++)
            cells.Add(new DateTime(current.Year, current.Month, day));

        // pad to full weeks (nice grid)
        while (cells.Count % 7 != 0)
            cells.Add(null);
    }

    private async Task PrevMonth()
    {
        current = current.AddMonths(-1);
        await LoadMonth();
    }

    private async Task NextMonth()
    {
        current = current.AddMonths(1);
        await LoadMonth();
    }

    private void OpenDate(DateTime d)
    {
        Nav.NavigateTo($"/entry/{d:yyyy-MM-dd}");
    }
}

