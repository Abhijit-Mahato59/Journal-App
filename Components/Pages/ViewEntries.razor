@page "/entries"
@inject JournalService JournalService
@inject ExportService ExportService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@using Markdig

<PageTitle>View Entries - Journal App</PageTitle>

<div class="entries-page">
    <div class="page-header">
        <h1>Your Journal Entries</h1>
        @if (entries != null && entries.Any())
        {
            <button class="btn btn-secondary btn-export" @onclick="ExportToPdf" disabled="@isExporting">
                @(isExporting ? "Exporting..." : "Export PDF")
            </button>
        }
    </div>

    @if (!string.IsNullOrEmpty(exportMessage))
    {
        <div class="@(exportSuccess ? "success-message" : "error-message")">@exportMessage</div>
    }

    <div class="search-filter-section">
        <div class="search-bar">
            <input type="text" placeholder="Search by title or content..." @bind="searchTerm" @bind:event="oninput" @onkeydown="HandleSearchKeyDown" />
            <button class="btn-search" @onclick="ApplyFilters">Search</button>
        </div>

        <div class="filter-toggle">
            <button class="btn-filter-toggle" @onclick="ToggleFilters">
                @(showFilters ? "Hide Filters" : "Show Filters")
                @if (HasActiveFilters())
                {
                    <span class="active-filter-indicator"></span>
                }
            </button>
            @if (HasActiveFilters())
            {
                <button class="btn-clear-filters" @onclick="ClearFilters">Clear All</button>
            }
        </div>

        @if (showFilters)
        {
            <div class="filter-panel">
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Mood Category</label>
                        <select @bind="selectedMoodCategory" @bind:after="ApplyFilters">
                            <option value="">All Categories</option>
                            <option value="Positive">Positive</option>
                            <option value="Neutral">Neutral</option>
                            <option value="Negative">Negative</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>Specific Mood</label>
                        <select @bind="selectedMood" @bind:after="ApplyFilters">
                            <option value="">All Moods</option>
                            @foreach (var mood in MoodCategories.GetAllMoods())
                            {
                                <option value="@mood">@mood</option>
                            }
                        </select>
                    </div>
                </div>

                <div class="filter-row">
                    <div class="filter-group">
                        <label>From Date</label>
                        <input type="date" @bind="startDate" @bind:after="ApplyFilters" />
                    </div>

                    <div class="filter-group">
                        <label>To Date</label>
                        <input type="date" @bind="endDate" @bind:after="ApplyFilters" />
                    </div>
                </div>

                @if (availableTags.Any())
                {
                    <div class="filter-group">
                        <label>Tag</label>
                        <select @bind="selectedTag" @bind:after="ApplyFilters">
                            <option value="">All Tags</option>
                            @foreach (var tag in availableTags)
                            {
                                <option value="@tag">@tag</option>
                            }
                        </select>
                    </div>
                }
            </div>
        }
    </div>

    @if (HasActiveFilters())
    {
        <div class="results-info">
            <span>@totalCount result@(totalCount != 1 ? "s" : "") found</span>
        </div>
    }

    @if (isLoading)
    {
        <div class="loading">Loading entries...</div>
    }
    else if (entries == null || !entries.Any())
    {
        <div class="no-entries">
            @if (HasActiveFilters())
            {
                <p>No entries match your search criteria.</p>
                <button class="btn btn-secondary" @onclick="ClearFilters">Clear Filters</button>
            }
            else
            {
                <p>No journal entries yet. Start writing to see them here!</p>
                <a href="/write" class="btn btn-primary">Write Your First Entry</a>
            }
        </div>
    }
    else
    {
        <div class="entries-list">
            @foreach (var entry in entries)
            {
                <div class="entry-card card">
                    <div class="entry-header">
                        <div>
                            <h3>@entry.Title</h3>
                            <p class="entry-date">@entry.Date.ToString("MMMM dd, yyyy")</p>
                            <div class="entry-timestamps">
                                <span>Created At: @entry.CreatedAt.ToString("hh:mm tt")</span>
                                @if (entry.HasBeenEdited)
                                {
                                    <span>Updated At: @entry.UpdatedAt.ToString("hh:mm tt")</span>
                                }
                            </div>
                        </div>
                        <div class="entry-moods">
                            <span class="mood-badge mood-@(MoodCategories.GetMoodCategory(entry.PrimaryMood).ToLower())">
                                @entry.PrimaryMood
                            </span>
                            @if (!string.IsNullOrEmpty(entry.SecondaryMood1))
                            {
                                <span class="mood-badge mood-@(MoodCategories.GetMoodCategory(entry.SecondaryMood1).ToLower())">
                                    @entry.SecondaryMood1
                                </span>
                            }
                            @if (!string.IsNullOrEmpty(entry.SecondaryMood2))
                            {
                                <span class="mood-badge mood-@(MoodCategories.GetMoodCategory(entry.SecondaryMood2).ToLower())">
                                    @entry.SecondaryMood2
                                </span>
                            }
                        </div>
                    </div>

                    <div class="entry-preview">
                        @((MarkupString)GetHtmlPreview(entry.Content))
                    </div>

                    <div class="entry-meta">
                        <div style="display: flex; gap: 20px;">
                            <span>@entry.WordCount words</span>
                            @if (!string.IsNullOrEmpty(entry.Tags))
                            {
                                <span>@entry.Tags</span>
                            }
                        </div>
                        <div class="entry-actions">
                            @if (entry.Date.Date == DateTime.Today)
                            {
                                <button class="btn-edit" @onclick="() => EditEntry()">Edit</button>
                            }
                            <button class="btn-export-entry" @onclick="() => ExportSingleEntry(entry)" disabled="@(exportingEntryId == entry.Id)">
                                @(exportingEntryId == entry.Id ? "Exporting..." : "Export PDF")
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>

        @if (hasMore)
        {
            <div class="text-center mt-3">
                <button class="btn btn-secondary" @onclick="LoadMore" disabled="@isLoadingMore">
                    @(isLoadingMore ? "Loading..." : "Load More")
                </button>
            </div>
        }
    }
</div>

@code {
    private List<JournalEntry> entries = new();
    private bool isLoading = true;
    private bool isLoadingMore = false;
    private bool hasMore = true;
    private int currentPage = 0;
    private int totalCount = 0;
    private const int PageSize = 10;

    // Search & Filter state
    private string searchTerm = "";
    private string selectedMood = "";
    private string selectedMoodCategory = "";
    private string selectedTag = "";
    private DateTime? startDate;
    private DateTime? endDate;
    private bool showFilters = false;
    private List<string> availableTags = new();
    private bool isExporting = false;
    private int? exportingEntryId = null;
    private string? exportMessage;
    private bool exportSuccess = false;

    protected override async Task OnInitializedAsync()
    {
        availableTags = await JournalService.GetAllUsedTagsAsync();
        await LoadEntries();
    }

    private async Task LoadEntries()
    {
        try
        {
            var result = await JournalService.GetFilteredEntriesAsync(
                searchTerm: string.IsNullOrWhiteSpace(searchTerm) ? null : searchTerm,
                moodFilter: string.IsNullOrWhiteSpace(selectedMood) ? null : selectedMood,
                moodCategory: string.IsNullOrWhiteSpace(selectedMoodCategory) ? null : selectedMoodCategory,
                tagFilter: string.IsNullOrWhiteSpace(selectedTag) ? null : selectedTag,
                startDate: startDate,
                endDate: endDate,
                skip: currentPage * PageSize,
                take: PageSize);

            entries.AddRange(result.entries);
            totalCount = result.totalCount;
            hasMore = entries.Count < totalCount;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading entries: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadMore()
    {
        isLoadingMore = true;
        currentPage++;
        await LoadEntries();
        isLoadingMore = false;
    }

    private async Task ApplyFilters()
    {
        isLoading = true;
        entries.Clear();
        currentPage = 0;
        hasMore = true;
        await LoadEntries();
    }

    private async Task ClearFilters()
    {
        searchTerm = "";
        selectedMood = "";
        selectedMoodCategory = "";
        selectedTag = "";
        startDate = null;
        endDate = null;
        await ApplyFilters();
    }

    private void ToggleFilters()
    {
        showFilters = !showFilters;
    }

    private bool HasActiveFilters()
    {
        return !string.IsNullOrWhiteSpace(searchTerm)
            || !string.IsNullOrWhiteSpace(selectedMood)
            || !string.IsNullOrWhiteSpace(selectedMoodCategory)
            || !string.IsNullOrWhiteSpace(selectedTag)
            || startDate.HasValue
            || endDate.HasValue;
    }

    private async Task HandleSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await ApplyFilters();
        }
    }

    private async Task ExportToPdf()
    {
        isExporting = true;
        exportMessage = null;
        StateHasChanged();

        try
        {
            var result = await JournalService.GetFilteredEntriesAsync(
                searchTerm: string.IsNullOrWhiteSpace(searchTerm) ? null : searchTerm,
                moodFilter: string.IsNullOrWhiteSpace(selectedMood) ? null : selectedMood,
                moodCategory: string.IsNullOrWhiteSpace(selectedMoodCategory) ? null : selectedMoodCategory,
                tagFilter: string.IsNullOrWhiteSpace(selectedTag) ? null : selectedTag,
                startDate: startDate,
                endDate: endDate,
                skip: 0,
                take: 10000);

            if (!result.entries.Any())
            {
                exportMessage = "No entries to export.";
                exportSuccess = false;
                return;
            }

            var pdfBytes = await ExportService.ExportToPdfAsync(result.entries);
            var fileName = $"Journal_Export_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";
            var savedPath = await SavePdfToDownloads(pdfBytes, fileName);

            exportMessage = $"PDF saved to: {savedPath}";
            exportSuccess = true;
        }
        catch (Exception ex)
        {
            exportMessage = $"Error exporting PDF: {ex.Message}";
            exportSuccess = false;
        }
        finally
        {
            isExporting = false;
        }
    }

    private async Task ExportSingleEntry(JournalEntry entry)
    {
        exportingEntryId = entry.Id;
        exportMessage = null;
        StateHasChanged();

        try
        {
            var pdfBytes = await ExportService.ExportSingleEntryToPdfAsync(entry);
            var safeTitle = string.Join("_", entry.Title.Split(Path.GetInvalidFileNameChars()));
            var fileName = $"Journal_{safeTitle}_{entry.Date:yyyyMMdd}.pdf";
            var savedPath = await SavePdfToDownloads(pdfBytes, fileName);

            exportMessage = $"PDF saved to: {savedPath}";
            exportSuccess = true;
        }
        catch (Exception ex)
        {
            exportMessage = $"Error exporting PDF: {ex.Message}";
            exportSuccess = false;
        }
        finally
        {
            exportingEntryId = null;
        }
    }

    private async Task<string> SavePdfToDownloads(byte[] pdfBytes, string fileName)
    {
        string downloadsPath;

#if WINDOWS
        try
        {
            downloadsPath = Windows.Storage.UserDataPaths.GetDefault().Downloads;
        }
        catch
        {
            // Fallback approaches
            var userProfile = Environment.GetFolderPath(Environment.SpecialFolder.UserProfile);
            if (string.IsNullOrEmpty(userProfile))
            {
                userProfile = Environment.GetEnvironmentVariable("USERPROFILE") ?? "";
            }
            downloadsPath = Path.Combine(userProfile, "Downloads");
        }
#elif ANDROID
        downloadsPath = Android.OS.Environment.GetExternalStoragePublicDirectory(Android.OS.Environment.DirectoryDownloads)!.AbsolutePath;
#else
        downloadsPath = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.UserProfile), "Downloads");
#endif

        Directory.CreateDirectory(downloadsPath);
        var filePath = Path.Combine(downloadsPath, fileName);
        await File.WriteAllBytesAsync(filePath, pdfBytes);
        return filePath;
    }

    private string GetHtmlPreview(string content)
    {
        if (string.IsNullOrWhiteSpace(content))
            return string.Empty;

        var preview = content.Length > 200 ? content.Substring(0, 200) + "..." : content;
        var pipeline = new MarkdownPipelineBuilder()
            .UseAdvancedExtensions()
            .UseSoftlineBreakAsHardlineBreak()
            .Build();
        var html = Markdown.ToHtml(preview, pipeline);
        return html;
    }

    private void EditEntry()
    {
        Navigation.NavigateTo("/write");
    }
}

<style>
    .entries-page {
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    h1 {
        font-size: 28px;
        margin: 0;
    }

    .btn-export {
        font-family: inherit;
        white-space: nowrap;
    }

    .success-message {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 8px;
        padding: 12px 20px;
        margin-bottom: 20px;
        color: #155724;
        font-size: 14px;
    }

    .error-message {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 8px;
        padding: 12px 20px;
        margin-bottom: 20px;
        color: #721c24;
        font-size: 14px;
    }

    /* Search & Filter Section */
    .search-filter-section {
        margin-bottom: 25px;
    }

    .search-bar {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }

        .search-bar input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            background-color: var(--input-bg);
            color: var(--text-primary);
        }

            .search-bar input::placeholder {
                color: var(--text-tertiary);
            }

            .search-bar input:focus {
                outline: none;
                border-color: var(--text-primary);
            }

    .btn-search {
        padding: 10px 20px;
        background: var(--text-primary);
        color: var(--bg-primary);
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-family: inherit;
        transition: all 0.2s;
    }

        .btn-search:hover {
            opacity: 0.85;
        }

    .filter-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

    .btn-filter-toggle {
        position: relative;
        padding: 6px 14px;
        background: var(--bg-secondary);
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        font-family: inherit;
        transition: all 0.2s;
    }

        .btn-filter-toggle:hover {
            background: var(--bg-tertiary);
        }

    .active-filter-indicator {
        display: inline-block;
        width: 6px;
        height: 6px;
        background: var(--text-primary);
        border-radius: 50%;
        margin-left: 6px;
        vertical-align: middle;
    }

    .btn-clear-filters {
        padding: 6px 14px;
        background: transparent;
        color: var(--text-tertiary);
        border: none;
        cursor: pointer;
        font-size: 13px;
        font-family: inherit;
        text-decoration: underline;
        transition: color 0.2s;
    }

        .btn-clear-filters:hover {
            color: var(--text-primary);
        }

    .filter-panel {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 10px;
    }

    .filter-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
    }

        .filter-row:last-child {
            margin-bottom: 0;
        }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-group select,
        .filter-group input[type="date"] {
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 13px;
            background-color: var(--input-bg);
            color: var(--text-primary);
            font-family: inherit;
        }

            .filter-group select:focus,
            .filter-group input[type="date"]:focus {
                outline: none;
                border-color: var(--text-primary);
            }

    .results-info {
        font-size: 13px;
        color: var(--text-tertiary);
        margin-bottom: 15px;
        padding: 8px 0;
        border-bottom: 1px solid var(--border-color);
    }

    /* Entries */
    .no-entries {
        text-align: center;
        padding: 60px 20px;
        background: var(--bg-secondary);
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }

        .no-entries p {
            color: var(--text-tertiary);
            margin-bottom: 20px;
        }

    .entries-list {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .entry-card {
        transition: transform 0.2s;
    }

        .entry-card:hover {
            transform: translateY(-2px);
        }

    .entry-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 15px;
        gap: 20px;
    }

        .entry-header h3 {
            font-size: 20px;
            margin: 0 0 5px 0;
            color: var(--text-primary);
        }

    .entry-date {
        color: var(--text-tertiary);
        font-size: 13px;
        margin: 0;
    }

    .entry-timestamps {
        display: flex;
        gap: 15px;
        font-size: 12px;
        color: var(--text-tertiary);
        margin-top: 4px;
    }

    .entry-moods {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
    }

    .entry-preview {
        color: var(--text-secondary);
        line-height: 1.6;
        margin-bottom: 15px;
    }

        .entry-preview p {
            margin: 0 0 10px 0;
        }

        .entry-preview strong {
            font-weight: 700;
            color: var(--text-primary);
        }

        .entry-preview em {
            font-style: italic;
        }

        .entry-preview h1, .entry-preview h2, .entry-preview h3 {
            margin: 0 0 8px 0;
            color: var(--text-primary);
        }

        .entry-preview ul, .entry-preview ol {
            margin: 0 0 10px 20px;
            padding: 0;
        }

        .entry-preview a {
            color: var(--text-primary);
            text-decoration: underline;
        }

    .entry-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 20px;
        font-size: 13px;
        color: var(--text-tertiary);
        padding-top: 15px;
        border-top: 1px solid var(--border-color);
    }

    .btn-edit {
        padding: 6px 16px;
        background: var(--text-primary);
        color: var(--bg-primary);
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s;
    }

        .btn-edit:hover {
            opacity: 0.8;
        }

    .entry-actions {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .btn-export-entry {
        padding: 6px 12px;
        background: var(--bg-secondary);
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        font-family: inherit;
        transition: all 0.2s;
    }

        .btn-export-entry:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--text-primary);
        }

        .btn-export-entry:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

    /* Responsive */
    @@media (max-width: 600px) {
        .search-bar {
            flex-direction: column;
        }

        .filter-row {
            grid-template-columns: 1fr;
        }
    }
</style>
