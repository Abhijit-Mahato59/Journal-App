@inherits LayoutComponentBase
@implements IDisposable
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

@if (currentPath == "login")
{
    @Body
}
else
{
    <AuthGuard>
        <div class="page">
            <div class="sidebar">
                <div class="top-row">
                    <h3 style="color: white; margin: 0;">Journal App</h3>
                </div>
                <NavMenu />
            </div>

            <main class="main">
                <div class="main-content">
                    @Body
                </div>
            </main>
        </div>
    </AuthGuard>
}

@code {
    private string currentPath = string.Empty;

    protected override void OnInitialized()
    {
        UpdateCurrentPath();
        Navigation.LocationChanged += OnLocationChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await ApplyStoredTheme();
        }
    }

    private async Task ApplyStoredTheme()
    {
        try
        {
            var theme = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "journal_theme");

            if (theme == "dark")
            {
                await JSRuntime.InvokeVoidAsync("eval", "document.documentElement.setAttribute('data-theme', 'dark')");
            }
            else if (theme == "auto")
            {
                await JSRuntime.InvokeVoidAsync("eval",
                    "if(window.matchMedia('(prefers-color-scheme:dark)').matches){document.documentElement.setAttribute('data-theme','dark')}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error applying theme: {ex.Message}");
        }
    }

    private void UpdateCurrentPath()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        currentPath = uri.PathAndQuery.TrimStart('/');

        // Extract just the path without query string
        var pathOnly = currentPath.Split('?')[0];
        currentPath = pathOnly;
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        UpdateCurrentPath();
        StateHasChanged();
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}